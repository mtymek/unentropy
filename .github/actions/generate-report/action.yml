name: "Unentropy Generate Report"
description: "Generate HTML report from collected metrics"
author: "Unentropy Team"
branding:
  icon: "file-text"
  color: "green"

inputs:
  database-path:
    description: "Path to local database file (should be provided by find-database action)"
    required: true
  output-dir:
    description: "Output directory for generated HTML report"
    required: false
    default: "./unentropy-report"
  time-range:
    description: 'Time range filter (e.g., "last-30-days", "all")'
    required: false
    default: "all"
  title:
    description: "Report title"
    required: false
    default: "Metrics Report"
  config-path:
    description: "Path to unentropy.json configuration file"
    required: false
    default: "./unentropy.json"

outputs:
  report-path:
    description: "Path to generated HTML report"
  metrics-count:
    description: "Number of metrics included in report"
  data-points:
    description: "Total number of data points in report"
  time-range-start:
    description: "ISO 8601 timestamp of oldest data point"
  time-range-end:
    description: "ISO 8601 timestamp of newest data point"

runs:
  using: "composite"
  steps:
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: "1.2"
    - name: Run report generation
      id: report
      shell: bash
      run: |
        # Create temp file for outputs
        OUTPUT_FILE=$(mktemp)

        # Run the Node.js script with output file
        bun "${{ github.action_path }}/dist/report.js" "$OUTPUT_FILE"

        # Read outputs from file and set them
        if [ -f "$OUTPUT_FILE" ]; then
          while IFS='=' read -r key value; do
            echo "$key=$value" >> $GITHUB_OUTPUT
          done < "$OUTPUT_FILE"
          rm "$OUTPUT_FILE"
        fi
      env:
        INPUT_DATABASE_PATH: ${{ inputs.database-path }}
        INPUT_OUTPUT_DIR: ${{ inputs.output-dir }}
        INPUT_TIME_RANGE: ${{ inputs.time-range }}
        INPUT_TITLE: ${{ inputs.title }}
        INPUT_CONFIG_PATH: ${{ inputs.config-path }}
