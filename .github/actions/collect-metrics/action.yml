name: "Unentropy Collect Metrics"
description: "Collect custom code metrics and store in SQLite database"
author: "Unentropy Team"
branding:
  icon: "bar-chart-2"
  color: "blue"

inputs:
  config-path:
    description: "Path to unentropy.json configuration file"
    required: false
    default: "./unentropy.json"
  database-path:
    description: "Path where database file is stored locally (should be provided by find-database action)"
    required: true
  continue-on-error:
    description: "Continue workflow if metric collection fails"
    required: false
    default: "true"

outputs:
  metrics-collected:
    description: "Count of successfully collected metrics"
  metrics-failed:
    description: "Count of metrics that failed to collect"
  database-path:
    description: "Path to the database file that was created/updated"
  build-id:
    description: "Database ID of the build context record created"

runs:
  using: "composite"
  steps:
    - name: Run metrics collection
      id: collect
      shell: bash
      run: |
        # Create temp file for outputs
        OUTPUT_FILE=$(mktemp)

        # Run the Node.js script with output file
        node "${{ github.action_path }}/dist/collect.js" "$OUTPUT_FILE"

        # Read outputs from file and set them
        if [ -f "$OUTPUT_FILE" ]; then
          while IFS='=' read -r key value; do
            echo "$key=$value" >> $GITHUB_OUTPUT
          done < "$OUTPUT_FILE"
          rm "$OUTPUT_FILE"
        fi
      env:
        INPUT_CONFIG_PATH: ${{ inputs.config-path }}
        INPUT_DATABASE_PATH: ${{ inputs.database-path }}
        INPUT_CONTINUE_ON_ERROR: ${{ inputs.continue-on-error }}
